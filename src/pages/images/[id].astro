---
import BaseLayout from "../../layouts/BaseLayout.astro";
import {
  acquisitionIntegration,
  formatDate,
  formatIntegrationSeconds,
  getAllImages,
  getImageAssetUrl,
  getImageById,
  getDetailedAcquisitions,
  getSiteData,
  getSkychartUrl,
  imageExposureSummary,
  imageFocalLengthMm,
  imageSessionCount,
  imageTotalIntegration
} from "../../lib/content";

export async function getStaticPaths() {
  const images = await getAllImages();
  return images.map((image) => ({
    params: { id: image.id }
  }));
}

const { id } = Astro.params;
if (!id) {
  throw new Error("Missing image id");
}

const image = await getImageById(id);
if (!image) {
  return Astro.redirect("/gallery");
}

const { objects, equipment, locations } = await getSiteData();

const location = locations.find((entry) => entry.id === image.location_id);
const objectItems = image.targets
  .map((targetId) => objects.find((entry) => entry.id === targetId))
  .filter((entry) => entry !== undefined);

const scope = equipment.find((entry) => entry.id === image.equipment.scope_id);
const mount = equipment.find((entry) => entry.id === image.equipment.mount_id);
const camera = equipment.find((entry) => entry.id === image.equipment.camera_id);
const filter = image.equipment.filter_id
  ? equipment.find((entry) => entry.id === image.equipment.filter_id)
  : undefined;

const totalIntegration = imageTotalIntegration(image);
const sessionCount = imageSessionCount(image);
const exposureSummary = imageExposureSummary(image);
const detailedAcquisitions = getDetailedAcquisitions(image);
const focalLengthMm = imageFocalLengthMm(image, scope);
const skychartUrl = getSkychartUrl(image);
const locationLat = location?.lat !== undefined ? location.lat.toFixed(4) : undefined;
const locationLon = location?.lon !== undefined ? location.lon.toFixed(4) : undefined;

const scopeAperture = typeof scope?.specs?.aperture_mm === "number" ? scope.specs.aperture_mm : null;
const scopeNativeFocal = typeof scope?.specs?.focal_length_mm === "number" ? scope.specs.focal_length_mm : null;
const scopeFRatioValue =
  typeof scope?.specs?.focal_ratio === "number"
    ? scope.specs.focal_ratio
    : scopeAperture && scopeNativeFocal
      ? scopeNativeFocal / scopeAperture
      : null;
const scopeFRatio = scopeFRatioValue ? `f/${scopeFRatioValue.toFixed(1)}` : null;

const mountTypeRaw = typeof mount?.specs?.mount_type === "string" ? mount.specs.mount_type : null;
const mountType = mountTypeRaw ? mountTypeRaw.replace(/-/g, " ") : null;

const filterTypeRaw = typeof filter?.specs?.filter_type === "string" ? filter.specs.filter_type : null;
const filterType = filterTypeRaw ? filterTypeRaw.replace(/-/g, " ") : null;
const filterSizeInch =
  typeof filter?.specs?.size_inch === "number" || typeof filter?.specs?.size_inch === "string"
    ? `${filter.specs.size_inch}\"`
    : null;

const showCaptureTile = totalIntegration !== null && sessionCount !== null && exposureSummary !== null;
const showCaptureDetails = detailedAcquisitions.length > 0;
const effectiveFRatio = scopeAperture && focalLengthMm ? focalLengthMm / scopeAperture : null;
const isSolarSystem = image.capture_mode === "solar_system";

const totalVideoFrames = detailedAcquisitions.reduce((sum, acquisition) => sum + acquisition.frames, 0);
const uniqueExposurePerFrame = Array.from(new Set(detailedAcquisitions.map((acquisition) => acquisition.exposure_s)));
const exposurePerFrame =
  uniqueExposurePerFrame.length === 1
    ? uniqueExposurePerFrame[0] < 1
      ? `${Math.round(uniqueExposurePerFrame[0] * 1000)} ms`
      : `${uniqueExposurePerFrame[0]} s`
    : "mixed";

const stackedPercentValues = detailedAcquisitions
  .map((acquisition) => acquisition.stacked_percent)
  .filter((value): value is number => typeof value === "number");
const stackedSummary =
  stackedPercentValues.length === 0
    ? null
    : Array.from(new Set(stackedPercentValues)).length === 1
      ? `${stackedPercentValues[0]}% stacked`
      : `${Math.min(...stackedPercentValues)}-${Math.max(...stackedPercentValues)}% stacked`;

const showDeepSkyCaptureTile = !isSolarSystem && showCaptureTile;
const showSolarCaptureTile = isSolarSystem && showCaptureDetails;
---

<BaseLayout
  title={`${image.title} | AstroCaptures`}
  description={image.description ?? image.title}
  image={getImageAssetUrl(image, "web")}
  canonicalPath={`/images/${image.id}`}
>
  <section class="hero">
    <h1>{image.title}</h1>
    <p class="muted">{formatDate(image.date)}</p>
    {image.description && <p>{image.description}</p>}
  </section>

  <section class="image-stage">
    <img
      src={getImageAssetUrl(image, "web")}
      alt={image.seo?.alt ?? image.title}
      loading="eager"
      fetchpriority="high"
    />
    <a class="download-btn" href={getImageAssetUrl(image, "original")} download>Download original JPG</a>

    <dl class="meta-grid">
      <div class="meta-tile">
        <dt>Location</dt>
        <dd>{location ? `${location.name}, ${location.country}` : image.location_id}</dd>
        {locationLat && locationLon && <small class="meta-sub">lat: {locationLat}, long: {locationLon}</small>}
        {location?.bortle && <small class="meta-sub">Bortle {location.bortle}</small>}
      </div>
      {showDeepSkyCaptureTile && (
        <div class="meta-tile">
          <dt>Capture</dt>
          <dd>{formatIntegrationSeconds(totalIntegration!)}</dd>
          <small class="meta-sub">
            {sessionCount!} session{sessionCount === 1 ? "" : "s"} 路 {exposureSummary!.value}
          </small>
          {exposureSummary!.secondary && <small class="meta-sub">{exposureSummary!.secondary}</small>}
        </div>
      )}
      {showSolarCaptureTile && (
        <div class="meta-tile">
          <dt>Capture</dt>
          <dd>{totalVideoFrames} video frames</dd>
          <small class="meta-sub">Exposure/frame: {exposurePerFrame}</small>
          {stackedSummary && <small class="meta-sub">{stackedSummary}</small>}
        </div>
      )}
      {focalLengthMm !== null && (
        <div class="meta-tile">
          <dt>Focal length</dt>
          <dd>{`${focalLengthMm} mm`}</dd>
          {effectiveFRatio !== null && <small class="meta-sub">{`f/${effectiveFRatio.toFixed(1)}`}</small>}
        </div>
      )}
    </dl>

    <div class="panel" style="margin-top:0.9rem;">
      <h2>Objects</h2>
      <div class="pill-list" style="margin-top:0.7rem;">
        {objectItems.map((item) => (
          <a class="pill" href={`/objects/${item.slug}`}>{item.title}</a>
        ))}
      </div>
    </div>

    <div class:list={{ "detail-grid": true, "detail-grid-single": !skychartUrl }} style="margin-top:0.9rem;">
      {skychartUrl && (
        <section class="panel">
          <h2>Sky Chart</h2>
          <img
            class="skychart-img"
            src={skychartUrl}
            alt={image.skychart?.caption ?? `Sky chart for ${image.title}`}
            loading="lazy"
          />
        </section>
      )}

      <aside class="panel meta-list">
        <div>
          <h2>Equipment</h2>
          <dd class="equipment-list">
            <div>
              <span class="equip-label">Scope</span>
              <span>{scope ? `${scope.brand} ${scope.model}` : image.equipment.scope_id}</span>
              {(scopeAperture || scopeNativeFocal || scopeFRatio) && (
                <small class="equipment-spec">
                  {scopeAperture && `${scopeAperture}mm`}
                  {scopeAperture && scopeNativeFocal && " 路 "}
                  {scopeNativeFocal && `${scopeNativeFocal}mm`}
                  {(scopeAperture || scopeNativeFocal) && scopeFRatio && " 路 "}
                  {scopeFRatio && scopeFRatio}
                </small>
              )}
            </div>
            <div>
              <span class="equip-label">Mount</span>
              <span>{mount ? `${mount.brand} ${mount.model}` : image.equipment.mount_id}</span>
              {mountType && <small class="equipment-spec">{mountType}</small>}
            </div>
            <div>
              <span class="equip-label">Camera</span>
              <span>{camera ? `${camera.brand} ${camera.model}` : image.equipment.camera_id}</span>
            </div>
            {filter && (
              <div>
                <span class="equip-label">Filter</span>
                <span>{`${filter.brand} ${filter.model}`}</span>
                {(filterType || filterSizeInch) && (
                  <small class="equipment-spec">
                    {filterType}
                    {filterType && filterSizeInch && " 路 "}
                    {filterSizeInch}
                  </small>
                )}
              </div>
            )}
          </dd>
        </div>
      </aside>
    </div>

    {showCaptureDetails && (
      <details class="panel capture-details" style="margin-top:0.9rem;">
        <summary>Capture details</summary>
        <table>
          <thead>
            {isSolarSystem ? (
              <tr>
                <th>Date</th>
                <th>Video frames</th>
                <th>Exposure/frame</th>
                <th>Stacked</th>
              </tr>
            ) : (
              <tr>
                <th>Date</th>
                <th>Frames</th>
                <th>Exposure</th>
                <th>Integration</th>
              </tr>
            )}
          </thead>
          <tbody>
            {detailedAcquisitions.map((acquisition) => (
              <tr>
                <td>{formatDate(acquisition.date)}</td>
                <td>{acquisition.frames}</td>
                <td>{acquisition.exposure_s < 1 ? `${Math.round(acquisition.exposure_s * 1000)} ms` : `${acquisition.exposure_s}s`}</td>
                {isSolarSystem ? (
                  <td>{typeof acquisition.stacked_percent === "number" ? `${acquisition.stacked_percent}%` : "-"}</td>
                ) : (
                  <td>{formatIntegrationSeconds(acquisitionIntegration(acquisition))}</td>
                )}
              </tr>
            ))}
          </tbody>
        </table>
      </details>
    )}
  </section>
</BaseLayout>
