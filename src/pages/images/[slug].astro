---
import BaseLayout from "../../layouts/BaseLayout.astro";
import {
  acquisitionIntegration,
  formatDate,
  formatIntegrationSeconds,
  getAllImages,
  getImageAssetUrl,
  getImageBySlug,
  getSiteData,
  getSkychartUrl,
  imageTotalIntegration
} from "../../lib/content";

export async function getStaticPaths() {
  const images = await getAllImages();
  return images.map((image) => ({
    params: { slug: image.slug }
  }));
}

const { slug } = Astro.params;
if (!slug) {
  throw new Error("Missing image slug");
}

const image = await getImageBySlug(slug);
if (!image) {
  return Astro.redirect("/gallery");
}

const { objects, equipment, locations } = await getSiteData();

const location = locations.find((entry) => entry.id === image.location_id);
const objectItems = image.targets
  .map((targetId) => objects.find((entry) => entry.id === targetId))
  .filter((entry) => entry !== undefined);

const scope = equipment.find((entry) => entry.id === image.equipment.scope_id);
const mount = equipment.find((entry) => entry.id === image.equipment.mount_id);
const camera = equipment.find((entry) => entry.id === image.equipment.camera_id);
const filter = image.equipment.filter_id
  ? equipment.find((entry) => entry.id === image.equipment.filter_id)
  : undefined;

const totalIntegration = imageTotalIntegration(image);
const skychartUrl = getSkychartUrl(image);
---

<BaseLayout
  title={`${image.title} | AstroCaptures`}
  description={image.description ?? image.title}
  image={getImageAssetUrl(image, "web")}
  canonicalPath={`/images/${image.slug}`}
>
  <section class="hero">
    <h1>{image.title}</h1>
    <p class="muted">{formatDate(image.date)}</p>
    {image.description && <p>{image.description}</p>}
  </section>

  <section class="detail-grid">
    <article class="panel">
      <img src={getImageAssetUrl(image, "web")} alt={image.seo?.alt ?? image.title} />
      <a class="download-btn" href={getImageAssetUrl(image, "original")} download>
        Download original JPG
      </a>

      {skychartUrl && (
        <div style="margin-top:1.2rem;">
          <h3>Sky Chart</h3>
          <img src={skychartUrl} alt={image.skychart?.caption ?? `Sky chart for ${image.title}`} loading="lazy" />
          {image.skychart?.caption && <p class="muted">{image.skychart.caption}</p>}
        </div>
      )}
    </article>

    <aside class="panel meta-list">
      <div>
        <dt>Capture mode</dt>
        <dd>{image.capture_mode.replace("_", " ")}</dd>
      </div>
      <div>
        <dt>Composition</dt>
        <dd>{image.composition_type}</dd>
      </div>
      <div>
        <dt>Location</dt>
        <dd>{location ? location.name : image.location_id}</dd>
      </div>
      <div>
        <dt>Total integration</dt>
        <dd>{formatIntegrationSeconds(totalIntegration)}</dd>
      </div>
      <div>
        <dt>Objects</dt>
        <dd class="pill-list">
          {objectItems.map((item) => (
            <a class="pill" href={`/objects/${item.slug}`}>{item.title}</a>
          ))}
        </dd>
      </div>
      <div>
        <dt>Equipment</dt>
        <dd>
          <div>{scope ? `${scope.brand} ${scope.model}` : image.equipment.scope_id}</div>
          <div>{mount ? `${mount.brand} ${mount.model}` : image.equipment.mount_id}</div>
          <div>{camera ? `${camera.brand} ${camera.model}` : image.equipment.camera_id}</div>
          {filter && <div>{`${filter.brand} ${filter.model}`}</div>}
        </dd>
      </div>
    </aside>
  </section>

  <section class="panel" style="margin-top:1rem;">
    <h2>Acquisitions</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Frames</th>
          <th>Exposure</th>
          <th>Integration</th>
        </tr>
      </thead>
      <tbody>
        {image.acquisitions.map((acquisition) => (
          <tr>
            <td>{formatDate(acquisition.date)}</td>
            <td>{acquisition.frames}</td>
            <td>{acquisition.exposure_s}s</td>
            <td>{formatIntegrationSeconds(acquisitionIntegration(acquisition))}</td>
          </tr>
        ))}
      </tbody>
    </table>
  </section>
</BaseLayout>
